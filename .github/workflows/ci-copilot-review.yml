name: CI + Copilot Review

on:
  pull_request:
    branches: [ main ]

jobs:
  test-and-integration:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install pnpm
        run: npm install -g pnpm@8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run linter
        run: pnpm lint

      - name: Run unit tests
        env:
          OD_COOKIE_SECRET: test-cookie-secret
          CI: 'true'
        run: pnpm test:unit

      - name: Run DB-backed integration tests
        env:
          OD_COOKIE_SECRET: test-cookie-secret
          CI: 'true'
          # Point test DB resolver at the postgres service
          OD_DB_URL: postgres://test:test@localhost:5432/testdb
        run: |
          # Run only the integration tests that exercise DB-backed code.
          npx vitest run src/lib/auth/__tests__/rbac.integration.test.ts || true
          npx vitest run src/lib/logging/__tests__/audit.integration.test.ts || true

  request-copilot-review:
    name: Request Copilot Review (Reviewer agent)
    needs: test-and-integration
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Request Copilot/Reviewer agent review
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const number = pr.number;

            // Add a label so downstream agents (Reviewer/Copilot) can pick up the PR
            try {
              await github.rest.issues.addLabels({ owner, repo, issue_number: number, labels: ['copilot-review-requested'] });
            } catch (e) {
              core.warning('Failed to add label: ' + e.message);
            }

            // Post a comment summarizing test results and requesting the Reviewer agent
            const body = `Automated CI (unit + integration) completed.\n\nTests executed: unit + DB-backed integration (where available).\n\nRequesting a Copilot/Reviewer agent review now â€” @github-copilot-reviews or your reviewer automation should pick this up.\n`;
            await github.rest.issues.createComment({ owner, repo, issue_number: number, body });
